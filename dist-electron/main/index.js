"use strict";const o=require("electron"),a=require("path"),A=require("child_process"),l=require("fs"),j=require("http"),B=require("os");function w(e){const n=`powershell -NoProfile -ExecutionPolicy Bypass -Command "${e}"`;A.exec(n,(i,r,t)=>{if(i){console.error(`执行出错: ${i.message}`);return}if(t){console.error(`脚本错误: ${t}`);return}})}const f={killProcess(e){const n=`taskkill /F /IM "${e}.exe"`;A.exec(n,i=>{i&&console.error("结束进程失败:",i)})},getHostsPath(){return process.platform==="win32"?"C:\\Windows\\System32\\drivers\\etc\\hosts":"/etc/hosts"},switchHosts(e){const n=this.getHostsPath();try{return l.copyFileSync(n,`${n}.bak`),l.appendFileSync(n,`
# QuickerUse Added
${e}
`),{success:!0,message:"Hosts 已更新"}}catch(i){return{success:!1,message:"写入 Hosts 失败，请以管理员运行: "+i.message}}},sendKeys(e){const n=`
      Add-Type -AssemblyName System.Windows.Forms
      [System.Windows.Forms.SendKeys]::SendWait('${e}')
    `;w(n)},windowAction(e){e==="minimize-all"&&w("(New-Object -ComObject Shell.Application).ToggleDesktop()")},simulateCopy(){process.platform==="win32"?w(`
        Add-Type -AssemblyName System.Windows.Forms
        [System.Windows.Forms.SendKeys]::SendWait('^c')
      `):process.platform==="darwin"&&A.exec(`osascript -e 'tell application "System Events" to keystroke "c" using {command down}'`,e=>{e&&console.error("Mac 复制失败:",e)})},lockScreen(){w("rundll32.exe user32.dll,LockWorkStation")},emptyTrash(){w("Clear-RecycleBin -Force -ErrorAction SilentlyContinue")}};function T(){const e=a.join(o.app.getPath("documents"),"QuickerUse","scripts");return l.existsSync(e)||l.mkdirSync(e,{recursive:!0}),e}const M={getScripts(){try{const e=T();return l.readdirSync(e).filter(i=>/\.(bat|cmd|ps1|sh|py|js)$/i.test(i)).map(i=>({name:i,path:a.join(e,i),type:a.extname(i).substring(1)}))}catch(e){return console.error("读取脚本目录失败:",e),[]}},runScript(e){if(!l.existsSync(e))return{success:!1,message:"文件不存在"};let n="";switch(a.extname(e).toLowerCase()){case".bat":case".cmd":n=`"${e}"`;break;case".ps1":n=`powershell -NoProfile -ExecutionPolicy Bypass -File "${e}"`;break;case".py":n=`python "${e}"`;break;case".js":n=`node "${e}"`;break;case".sh":n=`bash "${e}"`;break;default:n=`"${e}"`}return A.exec(n,(r,t,c)=>{if(r){console.error(`执行脚本出错: ${r.message}`);return}c&&console.error(`脚本输出错误: ${c}`),console.log(`脚本输出: ${t}`)}),{success:!0,message:"脚本已启动"}},openFolder(){const e=T(),n=process.platform==="win32"?`explorer "${e}"`:`open "${e}"`;A.exec(n)}};let d=null;const D=54321;function O(){const e=B.networkInterfaces();for(const n of Object.keys(e))for(const i of e[n])if(i.family==="IPv4"&&!i.internal)return i.address;return"127.0.0.1"}const H={startShare(e){d&&d.close();const n=a.basename(e);return d=j.createServer((r,t)=>{t.setHeader("Content-Disposition",`attachment; filename="${encodeURIComponent(n)}"`),l.createReadStream(e).pipe(t)}),d.listen(D),`http://${O()}:${D}`},stop(){d&&(d.close(),d=null)}},v=a.join(o.app.getPath("userData"),"secrets.json");let m={};function L(){if(l.existsSync(v))try{const e=JSON.parse(l.readFileSync(v,"utf-8"));if(!o.safeStorage.isEncryptionAvailable()){console.warn("SafeStorage 加密不可用，无法解密数据");return}for(const[n,i]of Object.entries(e))try{const r=Buffer.from(i,"hex"),t=o.safeStorage.decryptString(r);m[n]=t}catch(r){console.error(`解密 key [${n}] 失败:`,r)}}catch(e){console.error("加载密钥文件失败:",e)}}function E(){if(!o.safeStorage.isEncryptionAvailable())return console.error("SafeStorage 加密不可用，无法保存"),!1;const e={};for(const[n,i]of Object.entries(m))try{const r=o.safeStorage.encryptString(i);e[n]=r.toString("hex")}catch(r){console.error(`加密 key [${n}] 失败:`,r)}try{return l.writeFileSync(v,JSON.stringify(e,null,2)),!0}catch(n){return console.error("写入密钥文件失败:",n),!1}}L();const k={setItem(e,n){return m[e]=n,E()},getItem(e){return m[e]||null},removeItem(e){return delete m[e],E()},getAllKeys(){return Object.keys(m)},isAvailable(){return o.safeStorage.isEncryptionAvailable()}};let s=null,u=null,h=!1,b="Alt+Space",y=null,p=null,g=null;const P=process.env.NODE_ENV==="development",$=a.join(__dirname,"../../resources/MouseHook.exe");function z(){if(u&&p&&g){const e=h?g:p;u.setImage(e),u.setToolTip(h?"QuickerUse (已禁用)":"QuickerUse")}}function F(e=null){if(h)return;if(!e&&s&&s.isVisible()&&s.isFocused()){s.hide();return}const n=o.clipboard.readText();o.clipboard.clear(),f.simulateCopy(),setTimeout(()=>{let i=o.clipboard.readText();if(i||(o.clipboard.writeText(n),i=""),s&&s.isMinimized()&&s.restore(),e&&s)s.webContents.send("trigger-smart-action",{action:e,text:i});else if(s){const{x:r,y:t}=o.screen.getCursorScreenPoint(),[c,S]=s.getSize(),x=r-Math.round(c/2),U=t;s.setPosition(x,U),s.show(),s.setAlwaysOnTop(!0),s.setAlwaysOnTop(!1),s.focus(),s.webContents.send("clipboard-data",i)}},200)}function I(e){o.globalShortcut.unregisterAll();const n=o.globalShortcut.register(e,()=>{F()});W(),n?console.log(`${e} 注册成功`):console.error(`${e} 注册失败! 可能被其他软件占用。`)}let R={};function W(){for(const[e,n]of Object.entries(R))if(n)try{o.globalShortcut.register(n,()=>{console.log(`Smart Hotkey Triggered: ${e}`),F(e)})}catch{console.error(`Failed to register ${n} for ${e}`)}}async function C(){const e=o.screen.getPrimaryDisplay(),{width:n,height:i}=e.workAreaSize;if(s=new o.BrowserWindow({width:320,height:665,frame:!1,transparent:!1,backgroundColor:"#1e1e1e",resizable:!1,skipTaskbar:!1,show:!1,icon:p,webPreferences:{preload:a.join(__dirname,"../preload/index.js"),sandbox:!1,contextIsolation:!0,nodeIntegration:!1}}),o.app.commandLine.appendSwitch("ignore-certificate-errors"),s.webContents.on("certificate-error",(r,t,c,S,x)=>{r.preventDefault(),x(!0)}),console.log("[Main] Window created"),P){const r=process.env.VITE_DEV_SERVER_URL||"http://localhost:5173";console.log("[Main] Loading Dev URL:",r),await s.loadURL(r),s.webContents.openDevTools({mode:"detach"})}else s.loadFile(a.join(__dirname,"../../dist/index.html"));s.on("ready-to-show",()=>{}),o.ipcMain.on("update-global-hotkey",(r,t)=>{b=t,I(b)}),o.ipcMain.on("update-smart-hotkeys",(r,t)=>{R=t,I(b)}),o.ipcMain.on("run-path",async(r,t)=>{try{if(t.startsWith("http"))await o.shell.openExternal(t);else{const c=await o.shell.openPath(t);c&&console.error("打开路径失败:",c)}}catch(c){console.error("Run path error:",c)}}),o.ipcMain.on("window-control",(r,{action:t})=>{if(!s)return;const{width:c,height:S}=o.screen.getPrimaryDisplay().workAreaSize;switch(t){case"left":s.setBounds({x:0,y:0,width:Math.round(c/2),height:S});break;case"right":s.setBounds({x:Math.round(c/2),y:0,width:Math.round(c/2),height:S});break;case"full":s.maximize();break;case"center":s.setSize(320,650),s.center();break;case"pin":s.setAlwaysOnTop(!s.isAlwaysOnTop());break;case"minimize":s.minimize();break;case"hide":s.hide();break}}),o.ipcMain.on("system-action",(r,t)=>{t==="lock-screen"&&f.lockScreen(),t==="empty-trash"&&f.emptyTrash(),t==="minimize-all"&&f.windowAction("minimize-all"),t==="kill-process"&&f.killProcess("notepad"),t==="switch-hosts"&&f.switchHosts("127.0.0.1 quicker.local")}),o.ipcMain.on("script-action",(r,t)=>{t.action==="get-list"&&r.reply("script-list",M.getScripts()),t.action==="run"&&M.runScript(t.payload),t.action==="open-folder"&&M.openFolder()}),o.ipcMain.on("secret-action",(r,t)=>{t.action==="list"&&r.reply("secret-list",k.getAllKeys()),t.action==="get"&&r.reply("secret-value",{key:t.key,value:k.getItem(t.key)}),t.action==="set"&&k.setItem(t.key,t.value)&&r.reply("secret-op-result",{success:!0}),t.action==="delete"&&k.removeItem(t.key)&&r.reply("secret-op-result",{success:!0})}),o.ipcMain.on("file-server-action",(r,t)=>{t.action==="start"&&r.reply("file-server-url",H.startShare(t.payload))}),o.ipcMain.on("open-image-window",(r,t)=>{new o.BrowserWindow({width:400,height:300,frame:!1,alwaysOnTop:!0,webPreferences:{nodeIntegration:!1}}).loadURL(`data:text/html,<style>body{margin:0;background:black;display:flex;justify-content:center;align-items:center;height:100vh}img{max-width:100%;max-height:100%}</style><img src="${t}">`)}),o.ipcMain.on("minimize-window",()=>s.minimize()),o.ipcMain.on("close-window",()=>o.app.quit()),o.ipcMain.on("hide-window",()=>s.hide())}const Q=o.app.requestSingleInstanceLock();Q?(o.app.on("second-instance",()=>{s&&(s.isMinimized()&&s.restore(),s.show(),s.focus())}),o.app.whenReady().then(()=>{const e=a.join(__dirname,"../../"),n=a.join(e,"resources/icon.png"),i=a.join(e,"resources/icon-disabled.png");console.log("[Main] Project Root inferred as:",e),console.log("[Main] Looking for icon at:",n);const r="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABISURBVFhH7coxDQAACAOg9A/iFuuCB0zC2ZqZt9/Z+wUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFwFyGngX1090KyAAAAABJRU5ErkJggg==";try{l.existsSync(n)?(console.log("[Main] File exists. Loading..."),p=o.nativeImage.createFromPath(n),p.isEmpty()?(console.error("[Main] ERROR: Icon file exists but loaded image is EMPTY!"),p=o.nativeImage.createFromDataURL(r)):console.log("[Main] Icon loaded successfully. Size:",p.getSize())):(console.error("[Main] ERROR: Icon file NOT found at:",n),p=o.nativeImage.createFromDataURL(r)),l.existsSync(i)&&(g=o.nativeImage.createFromPath(i)),(!g||g.isEmpty())&&(g=o.nativeImage.createFromDataURL(r))}catch(t){console.error("[Main] EXCEPTION during icon load:",t),p=o.nativeImage.createFromDataURL(r)}C();try{u=new o.Tray(p),u.setToolTip("QuickerUse");const t=o.Menu.buildFromTemplate([{label:"退出",click:()=>o.app.quit()}]);u.setContextMenu(t),u.on("double-click",()=>{h=!h,z(),console.log(`App ${h?"Disabled":"Enabled"}`)}),console.log("[Main] Tray created successfully")}catch(t){console.error("[Main] FAILED to create Tray:",t)}I(b);try{console.log("Starting MouseHook:",$),y=A.spawn($),y.stdout.on("data",t=>{t.toString().trim().includes("MIDDLE_CLICK")&&(console.log("Middle Click Detected"),F())}),y.on("error",t=>{console.error("MouseHook Error:",t)}),y.on("close",t=>{console.log("MouseHook exited with code:",t)})}catch(t){console.error("Failed to start MouseHook:",t)}o.app.on("activate",()=>{o.BrowserWindow.getAllWindows().length===0&&C()})})):o.app.quit();o.app.on("window-all-closed",()=>{process.platform!=="darwin"&&o.app.quit()});o.app.on("will-quit",()=>{o.globalShortcut.unregisterAll(),y&&y.kill()});
